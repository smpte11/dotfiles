#!/bin/bash

set -eufo pipefail

echo "Installing packages declaratively..."

# Install brew packages (available on both macOS and Linux)
if command -v brew >/dev/null 2>&1; then
    echo "Installing brew packages..."
    brew bundle --verbose --file=/dev/stdin <<EOF
{{ range .packages.brews.packages -}}
brew {{ . | quote }}
{{ end -}}
{{ if eq .chezmoi.os "darwin" -}}
{{ range .packages.casks.packages -}}
cask {{ . | quote }}
{{ end -}}
{{ end -}}
EOF
    echo "Brew packages installed successfully"
else
    echo "Homebrew not found, skipping brew packages"

    # Helper for sudo
    SUDO=""
    if [ "$(id -u)" -ne 0 ] && command -v sudo >/dev/null 2>&1; then
        SUDO="sudo"
    fi

    # Fallback to system package manager for essentials
    if command -v apt-get >/dev/null 2>&1; then
        echo "Installing essentials via apt-get..."
        $SUDO apt-get update && $SUDO apt-get install -y git gcc make curl ca-certificates unzip
    elif command -v apk >/dev/null 2>&1; then
        echo "Installing essentials via apk..."
        $SUDO apk add git gcc make curl ca-certificates unzip
    elif command -v dnf >/dev/null 2>&1; then
        echo "Installing essentials via dnf..."
        $SUDO dnf install -y git gcc make curl ca-certificates unzip
    elif command -v pacman >/dev/null 2>&1; then
        echo "Installing essentials via pacman..."
        $SUDO pacman -Syu --noconfirm git gcc make curl ca-certificates unzip
    fi
fi

# Install flatpak packages (Bazzite/Bluefin only)
{{- if or (contains "bazzite" .chezmoi.hostname) (contains "bluefin" .chezmoi.hostname) }}
if command -v flatpak >/dev/null 2>&1; then
    echo "Installing flatpak packages..."
    {{ range .packages.flatpaks.packages -}}
    echo "Installing {{ . }}..."
    flatpak install -y --system --or-update {{ . | quote }}
    {{ end -}}
    echo "Flatpak packages installed successfully"
else
    echo "Flatpak not found, skipping flatpak packages"
fi
{{- else }}
echo "Not on Bazzite/Bluefin, skipping flatpak packages"
{{- end }}

# Install npm packages (cross-platform)
if command -v npm >/dev/null 2>&1; then
    echo "Installing npm packages..."
    {{ range .packages.npm.packages -}}
    echo "Installing {{ . }}..."
    npm install -g {{ . | quote }}
    {{ end -}}
    echo "npm packages installed successfully"
else
    echo "npm not found, skipping npm packages"
fi

echo "Package installation complete!"
