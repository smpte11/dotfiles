#!/bin/bash

set -eufo pipefail

echo "Installing packages declaratively..."

# Install native Linux packages
{{ if eq .chezmoi.os "linux" -}}
echo "Installing native Linux packages..."

packages="{{ .packages.linux.packages | join " " }}"

if command -v apt-get >/dev/null 2>&1; then
    # Debian/Ubuntu
    if [ "$(id -u)" -ne 0 ]; then SUDO="sudo"; else SUDO=""; fi
    $SUDO apt-get update
    $SUDO apt-get install -y build-essential $packages
elif command -v dnf >/dev/null 2>&1; then
    # Fedora/RHEL
    if [ "$(id -u)" -ne 0 ]; then SUDO="sudo"; else SUDO=""; fi
    $SUDO dnf groupinstall -y "Development Tools"
    $SUDO dnf install -y $packages
elif command -v apk >/dev/null 2>&1; then
    # Alpine Linux
    if [ "$(id -u)" -ne 0 ]; then SUDO="sudo"; else SUDO=""; fi
    $SUDO apk update
    $SUDO apk add build-base $packages
fi
{{ end -}}

# Install brew packages (available on both macOS and Linux)
if command -v brew >/dev/null 2>&1; then
    echo "Installing brew packages..."
    brew bundle --verbose --file=/dev/stdin <<EOF
{{ range .packages.brews.packages -}}
brew {{ . | quote }}
{{ end -}}
{{ if eq .chezmoi.os "darwin" -}}
{{ range .packages.casks.packages -}}
cask {{ . | quote }}
{{ end -}}
{{ end -}}
EOF
    echo "Brew packages installed successfully"
else
    echo "Homebrew not found, skipping brew packages"
fi

# Install flatpak packages (Bazzite/Bluefin only)
{{- if or (contains "bazzite" .chezmoi.hostname) (contains "bluefin" .chezmoi.hostname) }}
if command -v flatpak >/dev/null 2>&1; then
    echo "Installing flatpak packages..."
    {{ range .packages.flatpaks.packages -}}
    echo "Installing {{ . }}..."
    flatpak install -y --system --or-update {{ . | quote }}
    {{ end -}}
    echo "Flatpak packages installed successfully"
else
    echo "Flatpak not found, skipping flatpak packages"
fi
{{- else }}
echo "Not on Bazzite/Bluefin, skipping flatpak packages"
{{- end }}

# Install npm packages (cross-platform)
if command -v npm >/dev/null 2>&1; then
    echo "Installing npm packages..."
    {{ range .packages.npm.packages -}}
    echo "Installing {{ . }}..."
    npm install -g {{ . | quote }}
    {{ end -}}
    echo "npm packages installed successfully"
else
    echo "npm not found, skipping npm packages"
fi

echo "Package installation complete!"
